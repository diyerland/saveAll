'use strict';

var _ = require('lodash');
var isCoordinates = require('is-coordinates');

module.exports = function (options) {
  var errorHandler = require('../errorHandler')(options);

  function jsonQueryParser(key, value) {
    if (key === '$regex' && !options.allowRegex) {
      return undefined;
    }

    if (_.isString(value)) {
      if (value[0] === '~') {
        // parse RegExp
        return options.allowRegex ? new RegExp(value.substr(1), 'i') : undefined;
      } else if (value[0] === '>') {
        if (value[1] === '=') {
          return { $gte: value.substr(2) };
        } else {
          return { $gt: value.substr(1) };
        }
      } else if (value[0] === '<') {
        if (value[1] === '=') {
          return { $lte: value.substr(2) };
        } else {
          return { $lt: value.substr(1) };
        }
      } else if (value[0] === '!' && value[1] === '=') {
        return { $ne: value.substr(2) };
        /* This feature was disabled because it requires MongoDB 3
        } else if (value[0] === '=') {
          return { $eq: value.substr(1) }*/
      }
    } else if (_.isArray(value) && key[0] !== '$' && key !== 'coordinates' && !isCoordinates(value)) {
        return { $in: value };
      }

    return value;
  }

  function parseQueryOptions(queryOptions) {
    if (queryOptions.select && _.isString(queryOptions.select)) {
      var select = queryOptions.select.split(',');
      queryOptions.select = {};

      for (var i = 0, length = select.length; i < length; i++) {
        if (select[i][0] === '-') {
          queryOptions.select[select[i].substring(1)] = 0;
        } else {
          queryOptions.select[select[i]] = 1;
        }
      }
    }

    if (queryOptions.populate) {
      if (_.isString(queryOptions.populate)) {
        var populate = queryOptions.populate.split(',');
        queryOptions.populate = [];

        for (var _i = 0, _length = populate.length; _i < _length; _i++) {
          queryOptions.populate.push({
            path: populate[_i]
          });

          for (var key in queryOptions.select) {
            if (key.indexOf(populate[_i] + '.') === 0) {
              if (queryOptions.populate[_i].select) {
                queryOptions.populate[_i].select += ' ';
              } else {
                queryOptions.populate[_i].select = '';
              }

              if (queryOptions.select[key] === 0) {
                queryOptions.populate[_i].select += '-';
              }

              queryOptions.populate[_i].select += key.substring(populate[_i].length + 1);
              delete queryOptions.select[key];
            }
          }

          // If other specific fields are selected, add the populated field
          if (queryOptions.select) {
            if (Object.keys(queryOptions.select).length > 0 && !queryOptions.select[populate[_i]]) {
              queryOptions.select[populate[_i]] = 1;
            } else if (Object.keys(queryOptions.select).length === 0) {
              delete queryOptions.select;
            }
          }
        }
      } else if (!_.isArray(queryOptions.populate)) {
        queryOptions.populate = [queryOptions.populate];
      }
    }

    return queryOptions;
  }

  return function (req, res, next) {
    var whitelist = ['distinct', 'limit', 'populate', 'query', 'select', 'skip', 'sort'];

    req._ermQueryOptions = {};

    for (var key in req.query) {
      if (whitelist.indexOf(key) === -1) {
        continue;
      }

      if (key === 'query') {
        try {
          req._ermQueryOptions[key] = JSON.parse(req.query[key], jsonQueryParser);
        } catch (e) {
          return errorHandler(req, res, next)(new Error('invalid_json_' + key));
        }
      } else if (key === 'populate' || key === 'select' || key === 'sort') {
        try {
          req._ermQueryOptions[key] = JSON.parse(req.query[key]);
        } catch (e) {
          req._ermQueryOptions[key] = req.query[key];
        }
      } else if (key === 'limit' || key === 'skip') {
        req._ermQueryOptions[key] = parseInt(req.query[key], 10);
      } else {
        req._ermQueryOptions[key] = req.query[key];
      }
    }

    req._ermQueryOptions = parseQueryOptions(req._ermQueryOptions);

    next();
  };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlL3ByZXBhcmVRdWVyeS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLElBQU0sSUFBSSxRQUFRLFFBQVIsQ0FBSjtBQUNOLElBQU0sZ0JBQWdCLFFBQVEsZ0JBQVIsQ0FBaEI7O0FBRU4sT0FBTyxPQUFQLEdBQWlCLFVBQVUsT0FBVixFQUFtQjtBQUNsQyxNQUFNLGVBQWUsUUFBUSxpQkFBUixFQUEyQixPQUEzQixDQUFmLENBRDRCOztBQUdsQyxXQUFTLGVBQVQsQ0FBMEIsR0FBMUIsRUFBK0IsS0FBL0IsRUFBc0M7QUFDcEMsUUFBSSxRQUFRLFFBQVIsSUFBb0IsQ0FBQyxRQUFRLFVBQVIsRUFBb0I7QUFDM0MsYUFBTyxTQUFQLENBRDJDO0tBQTdDOztBQUlBLFFBQUksRUFBRSxRQUFGLENBQVcsS0FBWCxDQUFKLEVBQXVCO0FBQ3JCLFVBQUksTUFBTSxDQUFOLE1BQWEsR0FBYixFQUFrQjs7QUFDcEIsZUFBTyxRQUFRLFVBQVIsR0FBcUIsSUFBSSxNQUFKLENBQVcsTUFBTSxNQUFOLENBQWEsQ0FBYixDQUFYLEVBQTRCLEdBQTVCLENBQXJCLEdBQXdELFNBQXhELENBRGE7T0FBdEIsTUFFTyxJQUFJLE1BQU0sQ0FBTixNQUFhLEdBQWIsRUFBa0I7QUFDM0IsWUFBSSxNQUFNLENBQU4sTUFBYSxHQUFiLEVBQWtCO0FBQ3BCLGlCQUFPLEVBQUUsTUFBTSxNQUFNLE1BQU4sQ0FBYSxDQUFiLENBQU4sRUFBVCxDQURvQjtTQUF0QixNQUVPO0FBQ0wsaUJBQU8sRUFBRSxLQUFLLE1BQU0sTUFBTixDQUFhLENBQWIsQ0FBTCxFQUFULENBREs7U0FGUDtPQURLLE1BTUEsSUFBSSxNQUFNLENBQU4sTUFBYSxHQUFiLEVBQWtCO0FBQzNCLFlBQUksTUFBTSxDQUFOLE1BQWEsR0FBYixFQUFrQjtBQUNwQixpQkFBTyxFQUFFLE1BQU0sTUFBTSxNQUFOLENBQWEsQ0FBYixDQUFOLEVBQVQsQ0FEb0I7U0FBdEIsTUFF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UCxFQUFVO0FBQ1YsaUJBQU8sYUFBYSxHQUFiLEVBQWtCLEdBQWxCLEVBQXVCLElBQXZCLEVBQTZCLElBQUksS0FBSixtQkFBMEIsR0FBMUIsQ0FBN0IsQ0FBUCxDQURVO1NBQVY7T0FISixNQU1PLElBQUksUUFBUSxVQUFSLElBQXNCLFFBQVEsUUFBUixJQUFvQixRQUFRLE1BQVIsRUFBZ0I7QUFDbkUsWUFBSTtBQUNGLGNBQUksZ0JBQUosQ0FBcUIsR0FBckIsSUFBNEIsS0FBSyxLQUFMLENBQVcsSUFBSSxLQUFKLENBQVUsR0FBVixDQUFYLENBQTVCLENBREU7U0FBSixDQUVFLE9BQU8sQ0FBUCxFQUFVO0FBQ1YsY0FBSSxnQkFBSixDQUFxQixHQUFyQixJQUE0QixJQUFJLEtBQUosQ0FBVSxHQUFWLENBQTVCLENBRFU7U0FBVjtPQUhHLE1BTUEsSUFBSSxRQUFRLE9BQVIsSUFBbUIsUUFBUSxNQUFSLEVBQWdCO0FBQzVDLFlBQUksZ0JBQUosQ0FBcUIsR0FBckIsSUFBNEIsU0FBUyxJQUFJLEtBQUosQ0FBVSxHQUFWLENBQVQsRUFBeUIsRUFBekIsQ0FBNUIsQ0FENEM7T0FBdkMsTUFFQTtBQUNMLFlBQUksZ0JBQUosQ0FBcUIsR0FBckIsSUFBNEIsSUFBSSxLQUFKLENBQVUsR0FBVixDQUE1QixDQURLO09BRkE7S0FqQlQ7O0FBd0JBLFFBQUksZ0JBQUosR0FBdUIsa0JBQWtCLElBQUksZ0JBQUosQ0FBekMsQ0E3QitCOztBQStCL0IsV0EvQitCO0dBQTFCLENBOUYyQjtDQUFuQiIsImZpbGUiOiJwcmVwYXJlUXVlcnkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJylcclxuY29uc3QgaXNDb29yZGluYXRlcyA9IHJlcXVpcmUoJ2lzLWNvb3JkaW5hdGVzJylcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gKG9wdGlvbnMpIHtcclxuICBjb25zdCBlcnJvckhhbmRsZXIgPSByZXF1aXJlKCcuLi9lcnJvckhhbmRsZXInKShvcHRpb25zKVxyXG5cclxuICBmdW5jdGlvbiBqc29uUXVlcnlQYXJzZXIgKGtleSwgdmFsdWUpIHtcclxuICAgIGlmIChrZXkgPT09ICckcmVnZXgnICYmICFvcHRpb25zLmFsbG93UmVnZXgpIHtcclxuICAgICAgcmV0dXJuIHVuZGVmaW5lZFxyXG4gICAgfVxyXG5cclxuICAgIGlmIChfLmlzU3RyaW5nKHZhbHVlKSkge1xyXG4gICAgICBpZiAodmFsdWVbMF0gPT09ICd+JykgeyAvLyBwYXJzZSBSZWdFeHBcclxuICAgICAgICByZXR1cm4gb3B0aW9ucy5hbGxvd1JlZ2V4ID8gbmV3IFJlZ0V4cCh2YWx1ZS5zdWJzdHIoMSksICdpJykgOiB1bmRlZmluZWRcclxuICAgICAgfSBlbHNlIGlmICh2YWx1ZVswXSA9PT0gJz4nKSB7XHJcbiAgICAgICAgaWYgKHZhbHVlWzFdID09PSAnPScpIHtcclxuICAgICAgICAgIHJldHVybiB7ICRndGU6IHZhbHVlLnN1YnN0cigyKSB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJldHVybiB7ICRndDogdmFsdWUuc3Vic3RyKDEpIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSBpZiAodmFsdWVbMF0gPT09ICc8Jykge1xyXG4gICAgICAgIGlmICh2YWx1ZVsxXSA9PT0gJz0nKSB7XHJcbiAgICAgICAgICByZXR1cm4geyAkbHRlOiB2YWx1ZS5zdWJzdHIoMikgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4geyAkbHQ6IHZhbHVlLnN1YnN0cigxKSB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2UgaWYgKHZhbHVlWzBdID09PSAnIScgJiYgdmFsdWVbMV0gPT09ICc9Jykge1xyXG4gICAgICAgIHJldHVybiB7ICRuZTogdmFsdWUuc3Vic3RyKDIpIH1cclxuICAgICAgLyogVGhpcyBmZWF0dXJlIHdhcyBkaXNhYmxlZCBiZWNhdXNlIGl0IHJlcXVpcmVzIE1vbmdvREIgM1xyXG4gICAgICB9IGVsc2UgaWYgKHZhbHVlWzBdID09PSAnPScpIHtcclxuICAgICAgICByZXR1cm4geyAkZXE6IHZhbHVlLnN1YnN0cigxKSB9Ki9cclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChfLmlzQXJyYXkodmFsdWUpICYmIGtleVswXSAhPT0gJyQnICYmIGtleSAhPT0gJ2Nvb3JkaW5hdGVzJyAmJiAhaXNDb29yZGluYXRlcyh2YWx1ZSkpIHtcclxuICAgICAgcmV0dXJuIHsgJGluOiB2YWx1ZSB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHZhbHVlXHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBwYXJzZVF1ZXJ5T3B0aW9ucyAocXVlcnlPcHRpb25zKSB7XHJcbiAgICBpZiAocXVlcnlPcHRpb25zLnNlbGVjdCAmJiBfLmlzU3RyaW5nKHF1ZXJ5T3B0aW9ucy5zZWxlY3QpKSB7XHJcbiAgICAgIGxldCBzZWxlY3QgPSBxdWVyeU9wdGlvbnMuc2VsZWN0LnNwbGl0KCcsJylcclxuICAgICAgcXVlcnlPcHRpb25zLnNlbGVjdCA9IHt9XHJcblxyXG4gICAgICBmb3IgKGxldCBpID0gMCwgbGVuZ3RoID0gc2VsZWN0Lmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgaWYgKHNlbGVjdFtpXVswXSA9PT0gJy0nKSB7XHJcbiAgICAgICAgICBxdWVyeU9wdGlvbnMuc2VsZWN0W3NlbGVjdFtpXS5zdWJzdHJpbmcoMSldID0gMFxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBxdWVyeU9wdGlvbnMuc2VsZWN0W3NlbGVjdFtpXV0gPSAxXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHF1ZXJ5T3B0aW9ucy5wb3B1bGF0ZSkge1xyXG4gICAgICBpZiAoXy5pc1N0cmluZyhxdWVyeU9wdGlvbnMucG9wdWxhdGUpKSB7XHJcbiAgICAgICAgbGV0IHBvcHVsYXRlID0gcXVlcnlPcHRpb25zLnBvcHVsYXRlLnNwbGl0KCcsJylcclxuICAgICAgICBxdWVyeU9wdGlvbnMucG9wdWxhdGUgPSBbXVxyXG5cclxuICAgICAgICBmb3IgKGxldCBpID0gMCwgbGVuZ3RoID0gcG9wdWxhdGUubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5wb3B1bGF0ZS5wdXNoKHtcclxuICAgICAgICAgICAgcGF0aDogcG9wdWxhdGVbaV1cclxuICAgICAgICAgIH0pXHJcblxyXG4gICAgICAgICAgZm9yIChsZXQga2V5IGluIHF1ZXJ5T3B0aW9ucy5zZWxlY3QpIHtcclxuICAgICAgICAgICAgaWYgKGtleS5pbmRleE9mKHBvcHVsYXRlW2ldICsgJy4nKSA9PT0gMCkge1xyXG4gICAgICAgICAgICAgIGlmIChxdWVyeU9wdGlvbnMucG9wdWxhdGVbaV0uc2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMucG9wdWxhdGVbaV0uc2VsZWN0ICs9ICcgJ1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMucG9wdWxhdGVbaV0uc2VsZWN0ID0gJydcclxuICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgIGlmIChxdWVyeU9wdGlvbnMuc2VsZWN0W2tleV0gPT09IDApIHtcclxuICAgICAgICAgICAgICAgIHF1ZXJ5T3B0aW9ucy5wb3B1bGF0ZVtpXS5zZWxlY3QgKz0gJy0nXHJcbiAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICBxdWVyeU9wdGlvbnMucG9wdWxhdGVbaV0uc2VsZWN0ICs9IGtleS5zdWJzdHJpbmcocG9wdWxhdGVbaV0ubGVuZ3RoICsgMSlcclxuICAgICAgICAgICAgICBkZWxldGUgcXVlcnlPcHRpb25zLnNlbGVjdFtrZXldXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAvLyBJZiBvdGhlciBzcGVjaWZpYyBmaWVsZHMgYXJlIHNlbGVjdGVkLCBhZGQgdGhlIHBvcHVsYXRlZCBmaWVsZFxyXG4gICAgICAgICAgaWYgKHF1ZXJ5T3B0aW9ucy5zZWxlY3QpIHtcclxuICAgICAgICAgICAgaWYgKE9iamVjdC5rZXlzKHF1ZXJ5T3B0aW9ucy5zZWxlY3QpLmxlbmd0aCA+IDAgJiYgIXF1ZXJ5T3B0aW9ucy5zZWxlY3RbcG9wdWxhdGVbaV1dKSB7XHJcbiAgICAgICAgICAgICAgcXVlcnlPcHRpb25zLnNlbGVjdFtwb3B1bGF0ZVtpXV0gPSAxXHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoT2JqZWN0LmtleXMocXVlcnlPcHRpb25zLnNlbGVjdCkubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgZGVsZXRlIHF1ZXJ5T3B0aW9ucy5zZWxlY3RcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIGlmICghXy5pc0FycmF5KHF1ZXJ5T3B0aW9ucy5wb3B1bGF0ZSkpIHtcclxuICAgICAgICBxdWVyeU9wdGlvbnMucG9wdWxhdGUgPSBbcXVlcnlPcHRpb25zLnBvcHVsYXRlXVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHF1ZXJ5T3B0aW9uc1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGZ1bmN0aW9uIChyZXEsIHJlcywgbmV4dCkge1xyXG4gICAgY29uc3Qgd2hpdGVsaXN0ID0gWydkaXN0aW5jdCcsICdsaW1pdCcsICdwb3B1bGF0ZScsICdxdWVyeScsICdzZWxlY3QnLCAnc2tpcCcsICdzb3J0J11cclxuXHJcbiAgICByZXEuX2VybVF1ZXJ5T3B0aW9ucyA9IHt9XHJcblxyXG4gICAgZm9yIChsZXQga2V5IGluIHJlcS5xdWVyeSkge1xyXG4gICAgICBpZiAod2hpdGVsaXN0LmluZGV4T2Yoa2V5KSA9PT0gLTEpIHtcclxuICAgICAgICBjb250aW51ZVxyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoa2V5ID09PSAncXVlcnknKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIHJlcS5fZXJtUXVlcnlPcHRpb25zW2tleV0gPSBKU09OLnBhcnNlKHJlcS5xdWVyeVtrZXldLCBqc29uUXVlcnlQYXJzZXIpXHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgcmV0dXJuIGVycm9ySGFuZGxlcihyZXEsIHJlcywgbmV4dCkobmV3IEVycm9yKGBpbnZhbGlkX2pzb25fJHtrZXl9YCkpXHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ3BvcHVsYXRlJyB8fCBrZXkgPT09ICdzZWxlY3QnIHx8IGtleSA9PT0gJ3NvcnQnKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIHJlcS5fZXJtUXVlcnlPcHRpb25zW2tleV0gPSBKU09OLnBhcnNlKHJlcS5xdWVyeVtrZXldKVxyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgIHJlcS5fZXJtUXVlcnlPcHRpb25zW2tleV0gPSByZXEucXVlcnlba2V5XVxyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICdsaW1pdCcgfHwga2V5ID09PSAnc2tpcCcpIHtcclxuICAgICAgICByZXEuX2VybVF1ZXJ5T3B0aW9uc1trZXldID0gcGFyc2VJbnQocmVxLnF1ZXJ5W2tleV0sIDEwKVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlcS5fZXJtUXVlcnlPcHRpb25zW2tleV0gPSByZXEucXVlcnlba2V5XVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVxLl9lcm1RdWVyeU9wdGlvbnMgPSBwYXJzZVF1ZXJ5T3B0aW9ucyhyZXEuX2VybVF1ZXJ5T3B0aW9ucylcclxuXHJcbiAgICBuZXh0KClcclxuICB9XHJcbn1cclxuIl19
//# sourceMappingURL=prepareQuery.js.map