'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var _ = require('lodash');
var http = require('http');
var moredots = require('moredots');

module.exports = function (model, options, excludedMap) {
  var buildQuery = require('./buildQuery')(options);
  var errorHandler = require('./errorHandler')(options);

  function findById(filteredContext, id) {
    return filteredContext.findOne().and(_defineProperty({}, options.idProperty, id));
  }

  function isDistinctExcluded(req) {
    return options.filter.isExcluded(req._ermQueryOptions['distinct'], {
      access: req.access,
      excludedMap: excludedMap
    });
  }

  function getItems(req, res, next) {
    if (isDistinctExcluded(req)) {
      req.erm.result = [];
      req.erm.statusCode = 200;
      return next();
    }

    options.contextFilter(model, req, function (filteredContext) {
      var query = buildQuery(filteredContext.find(), req._ermQueryOptions).read(options.readPreference);

      query.lean(options.lean).exec().then(function (items) {
        req.erm.result = items;
        req.erm.statusCode = 200;

        if (options.totalCountHeader) {
          query.skip(0).limit(0).count().then(function (count) {
            req.erm.totalCount = count;
            next();
          }, errorHandler(req, res, next));
        } else {
          next();
        }
      }, errorHandler(req, res, next));
    });
  }

  function getCount(req, res, next) {
    options.contextFilter(model, req, function (filteredContext) {
      buildQuery(filteredContext.count(), req._ermQueryOptions).exec().then(function (count) {
        req.erm.result = { count: count };
        req.erm.statusCode = 200;

        next();
      }, errorHandler(req, res, next));
    });
  }

  function getShallow(req, res, next) {
    options.contextFilter(model, req, function (filteredContext) {
      buildQuery(findById(filteredContext, req.params.id), req._ermQueryOptions).lean(options.lean).read(options.readPreference).exec().then(function (item) {
        if (!item) {
          return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]));
        }

        for (var prop in item) {
          item[prop] = _typeof(item[prop]) === 'object' && prop !== '_id' ? true : item[prop];
        }

        req.erm.result = item;
        req.erm.statusCode = 200;

        next();
      }, errorHandler(req, res, next));
    });
  }

  function deleteItems(req, res, next) {
    options.contextFilter(model, req, function (filteredContext) {
      buildQuery(filteredContext.find(), req._ermQueryOptions).remove().then(function () {
        req.erm.statusCode = 204;

        next();
      }, errorHandler(req, res, next));
    });
  }

  function getItem(req, res, next) {
    if (isDistinctExcluded(req)) {
      req.erm.result = [];
      req.erm.statusCode = 200;
      return next();
    }

    options.contextFilter(model, req, function (filteredContext) {
      buildQuery(findById(filteredContext, req.params.id), req._ermQueryOptions).lean(options.lean).read(options.readPreference).exec().then(function (item) {
        if (!item) {
          return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]));
        }

        req.erm.result = item;
        req.erm.statusCode = 200;

        next();
      }, errorHandler(req, res, next));
    });
  }

  function deleteItem(req, res, next) {
    if (options.findOneAndRemove) {
      options.contextFilter(model, req, function (filteredContext) {
        findById(filteredContext, req.params.id).findOneAndRemove().then(function (item) {
          if (!item) {
            return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]));
          }

          req.erm.statusCode = 204;

          next();
        }, errorHandler(req, res, next));
      });
    } else {
      req.erm.document.remove().then(function () {
        req.erm.statusCode = 204;

        next();
      }, errorHandler(req, res, next));
    }
  }

  function createObject(req, res, next) {
    req.body = options.filter.filterObject(req.body || {}, {
      access: req.access,
      populate: req._ermQueryOptions.populate
    });

    if (model.schema.options._id) {
      delete req.body._id;
    }

    if (model.schema.options.versionKey) {
      delete req.body[model.schema.options.versionKey];
    }

    model.create(req.body).then(function (item) {
      return model.populate(item, req._ermQueryOptions.populate || []);
    }).then(function (item) {
      req.erm.result = item;
      req.erm.statusCode = 201;

      next();
    }, errorHandler(req, res, next));
  }

  function modifyObject(req, res, next) {
    req.body = options.filter.filterObject(req.body || {}, {
      access: req.access,
      populate: req._ermQueryOptions.populate
    });

    delete req.body._id;

    if (model.schema.options.versionKey) {
      delete req.body[model.schema.options.versionKey];
    }

    function depopulate(src) {
      var dst = {};

      for (var key in src) {
        var path = model.schema.path(key);

        if (path && path.caster && path.caster.instance === 'ObjectID') {
          if (_.isArray(src[key])) {
            for (var j = 0; j < src[key].length; ++j) {
              if (_typeof(src[key][j]) === 'object') {
                dst[key] = dst[key] || {};
                dst[key][j] = src[key][j]._id;
              }
            }
          } else if (_.isPlainObject(src[key])) {
            dst[key] = src[key]._id;
          }
        } else if (_.isPlainObject(src[key])) {
          if (path && path.instance === 'ObjectID') {
            dst[key] = src[key]._id;
          } else {
            dst[key] = depopulate(src[key]);
          }
        }

        if (_.isUndefined(dst[key])) {
          dst[key] = src[key];
        }
      }

      return dst;
    }

    var cleanBody = moredots(depopulate(req.body));

    if (options.findOneAndUpdate) {
      options.contextFilter(model, req, function (filteredContext) {
        findById(filteredContext, req.params.id).findOneAndUpdate({}, {
          $set: cleanBody
        }, {
          new: true,
          runValidators: options.runValidators
        }).exec().then(function (item) {
          return model.populate(item, req._ermQueryOptions.populate || []);
        }).then(function (item) {
          if (!item) {
            return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]));
          }

          req.erm.result = item;
          req.erm.statusCode = 200;

          next();
        }, errorHandler(req, res, next));
      });
    } else {
      for (var key in cleanBody) {
        req.erm.document.set(key, cleanBody[key]);
      }

      req.erm.document.save().then(function (item) {
        return model.populate(item, req._ermQueryOptions.populate || []);
      }).then(function (item) {
        req.erm.result = item;
        req.erm.statusCode = 200;

        next();
      }, errorHandler(req, res, next));
    }
  }

  return { getItems: getItems, getCount: getCount, getItem: getItem, getShallow: getShallow, createObject: createObject, modifyObject: modifyObject, deleteItems: deleteItems, deleteItem: deleteItem };
};
//# sourceMappingURL=data:application/json;base64,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IF8gPSByZXF1aXJlKCdsb2Rhc2gnKVxyXG5jb25zdCBodHRwID0gcmVxdWlyZSgnaHR0cCcpXHJcbmNvbnN0IG1vcmVkb3RzID0gcmVxdWlyZSgnbW9yZWRvdHMnKVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiAobW9kZWwsIG9wdGlvbnMsIGV4Y2x1ZGVkTWFwKSB7XHJcbiAgY29uc3QgYnVpbGRRdWVyeSA9IHJlcXVpcmUoJy4vYnVpbGRRdWVyeScpKG9wdGlvbnMpXHJcbiAgY29uc3QgZXJyb3JIYW5kbGVyID0gcmVxdWlyZSgnLi9lcnJvckhhbmRsZXInKShvcHRpb25zKVxyXG5cclxuICBmdW5jdGlvbiBmaW5kQnlJZCAoZmlsdGVyZWRDb250ZXh0LCBpZCkge1xyXG4gICAgcmV0dXJuIGZpbHRlcmVkQ29udGV4dC5maW5kT25lKCkuYW5kKHtcclxuICAgICAgW29wdGlvbnMuaWRQcm9wZXJ0eV06IGlkXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gaXNEaXN0aW5jdEV4Y2x1ZGVkIChyZXEpIHtcclxuICAgIHJldHVybiBvcHRpb25zLmZpbHRlci5pc0V4Y2x1ZGVkKHJlcS5fZXJtUXVlcnlPcHRpb25zWydkaXN0aW5jdCddLCB7XHJcbiAgICAgIGFjY2VzczogcmVxLmFjY2VzcyxcclxuICAgICAgZXhjbHVkZWRNYXA6IGV4Y2x1ZGVkTWFwXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gZ2V0SXRlbXMgKHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICBpZiAoaXNEaXN0aW5jdEV4Y2x1ZGVkKHJlcSkpIHtcclxuICAgICAgcmVxLmVybS5yZXN1bHQgPSBbXVxyXG4gICAgICByZXEuZXJtLnN0YXR1c0NvZGUgPSAyMDBcclxuICAgICAgcmV0dXJuIG5leHQoKVxyXG4gICAgfVxyXG5cclxuICAgIG9wdGlvbnMuY29udGV4dEZpbHRlcihtb2RlbCwgcmVxLCAoZmlsdGVyZWRDb250ZXh0KSA9PiB7XHJcbiAgICAgIGxldCBxdWVyeSA9IGJ1aWxkUXVlcnkoZmlsdGVyZWRDb250ZXh0LmZpbmQoKSwgcmVxLl9lcm1RdWVyeU9wdGlvbnMpLnJlYWQob3B0aW9ucy5yZWFkUHJlZmVyZW5jZSlcclxuXHJcbiAgICAgIHF1ZXJ5LmxlYW4ob3B0aW9ucy5sZWFuKS5leGVjKCkudGhlbigoaXRlbXMpID0+IHtcclxuICAgICAgICByZXEuZXJtLnJlc3VsdCA9IGl0ZW1zXHJcbiAgICAgICAgcmVxLmVybS5zdGF0dXNDb2RlID0gMjAwXHJcblxyXG4gICAgICAgIGlmIChvcHRpb25zLnRvdGFsQ291bnRIZWFkZXIpIHtcclxuICAgICAgICAgIHF1ZXJ5LnNraXAoMCkubGltaXQoMCkuY291bnQoKS50aGVuKChjb3VudCkgPT4ge1xyXG4gICAgICAgICAgICByZXEuZXJtLnRvdGFsQ291bnQgPSBjb3VudFxyXG4gICAgICAgICAgICBuZXh0KClcclxuICAgICAgICAgIH0sIGVycm9ySGFuZGxlcihyZXEsIHJlcywgbmV4dCkpXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIG5leHQoKVxyXG4gICAgICAgIH1cclxuICAgICAgfSwgZXJyb3JIYW5kbGVyKHJlcSwgcmVzLCBuZXh0KSlcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBnZXRDb3VudCAocmVxLCByZXMsIG5leHQpIHtcclxuICAgIG9wdGlvbnMuY29udGV4dEZpbHRlcihtb2RlbCwgcmVxLCAoZmlsdGVyZWRDb250ZXh0KSA9PiB7XHJcbiAgICAgIGJ1aWxkUXVlcnkoZmlsdGVyZWRDb250ZXh0LmNvdW50KCksIHJlcS5fZXJtUXVlcnlPcHRpb25zKS5leGVjKCkudGhlbigoY291bnQpID0+IHtcclxuICAgICAgICByZXEuZXJtLnJlc3VsdCA9IHsgY291bnQ6IGNvdW50IH1cclxuICAgICAgICByZXEuZXJtLnN0YXR1c0NvZGUgPSAyMDBcclxuXHJcbiAgICAgICAgbmV4dCgpXHJcbiAgICAgIH0sIGVycm9ySGFuZGxlcihyZXEsIHJlcywgbmV4dCkpXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gZ2V0U2hhbGxvdyAocmVxLCByZXMsIG5leHQpIHtcclxuICAgIG9wdGlvbnMuY29udGV4dEZpbHRlcihtb2RlbCwgcmVxLCAoZmlsdGVyZWRDb250ZXh0KSA9PiB7XHJcbiAgICAgIGJ1aWxkUXVlcnkoZmluZEJ5SWQoZmlsdGVyZWRDb250ZXh0LCByZXEucGFyYW1zLmlkKSwgcmVxLl9lcm1RdWVyeU9wdGlvbnMpLmxlYW4ob3B0aW9ucy5sZWFuKS5yZWFkKG9wdGlvbnMucmVhZFByZWZlcmVuY2UpLmV4ZWMoKS50aGVuKChpdGVtKSA9PiB7XHJcbiAgICAgICAgaWYgKCFpdGVtKSB7XHJcbiAgICAgICAgICByZXR1cm4gZXJyb3JIYW5kbGVyKHJlcSwgcmVzLCBuZXh0KShuZXcgRXJyb3IoaHR0cC5TVEFUVVNfQ09ERVNbNDA0XSkpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBmb3IgKGxldCBwcm9wIGluIGl0ZW0pIHtcclxuICAgICAgICAgIGl0ZW1bcHJvcF0gPSB0eXBlb2YgaXRlbVtwcm9wXSA9PT0gJ29iamVjdCcgJiYgcHJvcCAhPT0gJ19pZCcgPyB0cnVlIDogaXRlbVtwcm9wXVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmVxLmVybS5yZXN1bHQgPSBpdGVtXHJcbiAgICAgICAgcmVxLmVybS5zdGF0dXNDb2RlID0gMjAwXHJcblxyXG4gICAgICAgIG5leHQoKVxyXG4gICAgICB9LCBlcnJvckhhbmRsZXIocmVxLCByZXMsIG5leHQpKVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGRlbGV0ZUl0ZW1zIChyZXEsIHJlcywgbmV4dCkge1xyXG4gICAgb3B0aW9ucy5jb250ZXh0RmlsdGVyKG1vZGVsLCByZXEsIChmaWx0ZXJlZENvbnRleHQpID0+IHtcclxuICAgICAgYnVpbGRRdWVyeShmaWx0ZXJlZENvbnRleHQuZmluZCgpLCByZXEuX2VybVF1ZXJ5T3B0aW9ucykucmVtb3ZlKCkudGhlbigoKSA9PiB7XHJcbiAgICAgICAgcmVxLmVybS5zdGF0dXNDb2RlID0gMjA0XHJcblxyXG4gICAgICAgIG5leHQoKVxyXG4gICAgICB9LCBlcnJvckhhbmRsZXIocmVxLCByZXMsIG5leHQpKVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGdldEl0ZW0gKHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICBpZiAoaXNEaXN0aW5jdEV4Y2x1ZGVkKHJlcSkpIHtcclxuICAgICAgcmVxLmVybS5yZXN1bHQgPSBbXVxyXG4gICAgICByZXEuZXJtLnN0YXR1c0NvZGUgPSAyMDBcclxuICAgICAgcmV0dXJuIG5leHQoKVxyXG4gICAgfVxyXG5cclxuICAgIG9wdGlvbnMuY29udGV4dEZpbHRlcihtb2RlbCwgcmVxLCAoZmlsdGVyZWRDb250ZXh0KSA9PiB7XHJcbiAgICAgIGJ1aWxkUXVlcnkoZmluZEJ5SWQoZmlsdGVyZWRDb250ZXh0LCByZXEucGFyYW1zLmlkKSwgcmVxLl9lcm1RdWVyeU9wdGlvbnMpLmxlYW4ob3B0aW9ucy5sZWFuKS5yZWFkKG9wdGlvbnMucmVhZFByZWZlcmVuY2UpLmV4ZWMoKS50aGVuKChpdGVtKSA9PiB7XHJcbiAgICAgICAgaWYgKCFpdGVtKSB7XHJcbiAgICAgICAgICByZXR1cm4gZXJyb3JIYW5kbGVyKHJlcSwgcmVzLCBuZXh0KShuZXcgRXJyb3IoaHR0cC5TVEFUVVNfQ09ERVNbNDA0XSkpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXEuZXJtLnJlc3VsdCA9IGl0ZW1cclxuICAgICAgICByZXEuZXJtLnN0YXR1c0NvZGUgPSAyMDBcclxuXHJcbiAgICAgICAgbmV4dCgpXHJcbiAgICAgIH0sIGVycm9ySGFuZGxlcihyZXEsIHJlcywgbmV4dCkpXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gZGVsZXRlSXRlbSAocmVxLCByZXMsIG5leHQpIHtcclxuICAgIGlmIChvcHRpb25zLmZpbmRPbmVBbmRSZW1vdmUpIHtcclxuICAgICAgb3B0aW9ucy5jb250ZXh0RmlsdGVyKG1vZGVsLCByZXEsIChmaWx0ZXJlZENvbnRleHQpID0+IHtcclxuICAgICAgICBmaW5kQnlJZChmaWx0ZXJlZENvbnRleHQsIHJlcS5wYXJhbXMuaWQpLmZpbmRPbmVBbmRSZW1vdmUoKS50aGVuKChpdGVtKSA9PiB7XHJcbiAgICAgICAgICBpZiAoIWl0ZW0pIHtcclxuICAgICAgICAgICAgcmV0dXJuIGVycm9ySGFuZGxlcihyZXEsIHJlcywgbmV4dCkobmV3IEVycm9yKGh0dHAuU1RBVFVTX0NPREVTWzQwNF0pKVxyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIHJlcS5lcm0uc3RhdHVzQ29kZSA9IDIwNFxyXG5cclxuICAgICAgICAgIG5leHQoKVxyXG4gICAgICAgIH0sIGVycm9ySGFuZGxlcihyZXEsIHJlcywgbmV4dCkpXHJcbiAgICAgIH0pXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXEuZXJtLmRvY3VtZW50LnJlbW92ZSgpLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgIHJlcS5lcm0uc3RhdHVzQ29kZSA9IDIwNFxyXG5cclxuICAgICAgICBuZXh0KClcclxuICAgICAgfSwgZXJyb3JIYW5kbGVyKHJlcSwgcmVzLCBuZXh0KSlcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGNyZWF0ZU9iamVjdCAocmVxLCByZXMsIG5leHQpIHtcclxuICAgIHJlcS5ib2R5ID0gb3B0aW9ucy5maWx0ZXIuZmlsdGVyT2JqZWN0KHJlcS5ib2R5IHx8IHt9LCB7XHJcbiAgICAgIGFjY2VzczogcmVxLmFjY2VzcyxcclxuICAgICAgcG9wdWxhdGU6IHJlcS5fZXJtUXVlcnlPcHRpb25zLnBvcHVsYXRlXHJcbiAgICB9KVxyXG5cclxuICAgIGlmIChtb2RlbC5zY2hlbWEub3B0aW9ucy5faWQpIHtcclxuICAgICAgZGVsZXRlIHJlcS5ib2R5Ll9pZFxyXG4gICAgfVxyXG5cclxuICAgIGlmIChtb2RlbC5zY2hlbWEub3B0aW9ucy52ZXJzaW9uS2V5KSB7XHJcbiAgICAgIGRlbGV0ZSByZXEuYm9keVttb2RlbC5zY2hlbWEub3B0aW9ucy52ZXJzaW9uS2V5XVxyXG4gICAgfVxyXG5cclxuICAgIG1vZGVsLmNyZWF0ZShyZXEuYm9keSkudGhlbigoaXRlbSkgPT4gbW9kZWwucG9wdWxhdGUoaXRlbSwgcmVxLl9lcm1RdWVyeU9wdGlvbnMucG9wdWxhdGUgfHwgW10pKS50aGVuKChpdGVtKSA9PiB7XHJcbiAgICAgIHJlcS5lcm0ucmVzdWx0ID0gaXRlbVxyXG4gICAgICByZXEuZXJtLnN0YXR1c0NvZGUgPSAyMDFcclxuXHJcbiAgICAgIG5leHQoKVxyXG4gICAgfSwgZXJyb3JIYW5kbGVyKHJlcSwgcmVzLCBuZXh0KSlcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIG1vZGlmeU9iamVjdCAocmVxLCByZXMsIG5leHQpIHtcclxuICAgIHJlcS5ib2R5ID0gb3B0aW9ucy5maWx0ZXIuZmlsdGVyT2JqZWN0KHJlcS5ib2R5IHx8IHt9LCB7XHJcbiAgICAgIGFjY2VzczogcmVxLmFjY2VzcyxcclxuICAgICAgcG9wdWxhdGU6IHJlcS5fZXJtUXVlcnlPcHRpb25zLnBvcHVsYXRlXHJcbiAgICB9KVxyXG5cclxuICAgIGRlbGV0ZSByZXEuYm9keS5faWRcclxuXHJcbiAgICBpZiAobW9kZWwuc2NoZW1hLm9wdGlvbnMudmVyc2lvbktleSkge1xyXG4gICAgICBkZWxldGUgcmVxLmJvZHlbbW9kZWwuc2NoZW1hLm9wdGlvbnMudmVyc2lvbktleV1cclxuICAgIH1cclxuXHJcbiAgICBmdW5jdGlvbiBkZXBvcHVsYXRlIChzcmMpIHtcclxuICAgICAgbGV0IGRzdCA9IHt9XHJcblxyXG4gICAgICBmb3IgKGxldCBrZXkgaW4gc3JjKSB7XHJcbiAgICAgICAgY29uc3QgcGF0aCA9IG1vZGVsLnNjaGVtYS5wYXRoKGtleSlcclxuXHJcbiAgICAgICAgaWYgKHBhdGggJiYgcGF0aC5jYXN0ZXIgJiYgcGF0aC5jYXN0ZXIuaW5zdGFuY2UgPT09ICdPYmplY3RJRCcpIHtcclxuICAgICAgICAgIGlmIChfLmlzQXJyYXkoc3JjW2tleV0pKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgc3JjW2tleV0ubGVuZ3RoOyArK2opIHtcclxuICAgICAgICAgICAgICBpZiAodHlwZW9mIHNyY1trZXldW2pdID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgZHN0W2tleV0gPSBkc3Rba2V5XSB8fCB7fVxyXG4gICAgICAgICAgICAgICAgZHN0W2tleV1bal0gPSBzcmNba2V5XVtqXS5faWRcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSBpZiAoXy5pc1BsYWluT2JqZWN0KHNyY1trZXldKSkge1xyXG4gICAgICAgICAgICBkc3Rba2V5XSA9IHNyY1trZXldLl9pZFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAoXy5pc1BsYWluT2JqZWN0KHNyY1trZXldKSkge1xyXG4gICAgICAgICAgaWYgKHBhdGggJiYgcGF0aC5pbnN0YW5jZSA9PT0gJ09iamVjdElEJykge1xyXG4gICAgICAgICAgICBkc3Rba2V5XSA9IHNyY1trZXldLl9pZFxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZHN0W2tleV0gPSBkZXBvcHVsYXRlKHNyY1trZXldKVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKF8uaXNVbmRlZmluZWQoZHN0W2tleV0pKSB7XHJcbiAgICAgICAgICBkc3Rba2V5XSA9IHNyY1trZXldXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gZHN0XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY2xlYW5Cb2R5ID0gbW9yZWRvdHMoZGVwb3B1bGF0ZShyZXEuYm9keSkpXHJcblxyXG4gICAgaWYgKG9wdGlvbnMuZmluZE9uZUFuZFVwZGF0ZSkge1xyXG4gICAgICBvcHRpb25zLmNvbnRleHRGaWx0ZXIobW9kZWwsIHJlcSwgKGZpbHRlcmVkQ29udGV4dCkgPT4ge1xyXG4gICAgICAgIGZpbmRCeUlkKGZpbHRlcmVkQ29udGV4dCwgcmVxLnBhcmFtcy5pZCkuZmluZE9uZUFuZFVwZGF0ZSh7fSwge1xyXG4gICAgICAgICAgJHNldDogY2xlYW5Cb2R5XHJcbiAgICAgICAgfSwge1xyXG4gICAgICAgICAgbmV3OiB0cnVlLFxyXG4gICAgICAgICAgcnVuVmFsaWRhdG9yczogb3B0aW9ucy5ydW5WYWxpZGF0b3JzXHJcbiAgICAgICAgfSkuZXhlYygpLnRoZW4oKGl0ZW0pID0+IG1vZGVsLnBvcHVsYXRlKGl0ZW0sIHJlcS5fZXJtUXVlcnlPcHRpb25zLnBvcHVsYXRlIHx8IFtdKSkudGhlbigoaXRlbSkgPT4ge1xyXG4gICAgICAgICAgaWYgKCFpdGVtKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBlcnJvckhhbmRsZXIocmVxLCByZXMsIG5leHQpKG5ldyBFcnJvcihodHRwLlNUQVRVU19DT0RFU1s0MDRdKSlcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICByZXEuZXJtLnJlc3VsdCA9IGl0ZW1cclxuICAgICAgICAgIHJlcS5lcm0uc3RhdHVzQ29kZSA9IDIwMFxyXG5cclxuICAgICAgICAgIG5leHQoKVxyXG4gICAgICAgIH0sIGVycm9ySGFuZGxlcihyZXEsIHJlcywgbmV4dCkpXHJcbiAgICAgIH0pXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBmb3IgKGxldCBrZXkgaW4gY2xlYW5Cb2R5KSB7XHJcbiAgICAgICAgcmVxLmVybS5kb2N1bWVudC5zZXQoa2V5LCBjbGVhbkJvZHlba2V5XSlcclxuICAgICAgfVxyXG5cclxuICAgICAgcmVxLmVybS5kb2N1bWVudC5zYXZlKCkudGhlbigoaXRlbSkgPT4gbW9kZWwucG9wdWxhdGUoaXRlbSwgcmVxLl9lcm1RdWVyeU9wdGlvbnMucG9wdWxhdGUgfHwgW10pKS50aGVuKChpdGVtKSA9PiB7XHJcbiAgICAgICAgcmVxLmVybS5yZXN1bHQgPSBpdGVtXHJcbiAgICAgICAgcmVxLmVybS5zdGF0dXNDb2RlID0gMjAwXHJcblxyXG4gICAgICAgIG5leHQoKVxyXG4gICAgICB9LCBlcnJvckhhbmRsZXIocmVxLCByZXMsIG5leHQpKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHsgZ2V0SXRlbXMsIGdldENvdW50LCBnZXRJdGVtLCBnZXRTaGFsbG93LCBjcmVhdGVPYmplY3QsIG1vZGlmeU9iamVjdCwgZGVsZXRlSXRlbXMsIGRlbGV0ZUl0ZW0gfVxyXG59XHJcbiJdfQ==
//# sourceMappingURL=operations.js.map