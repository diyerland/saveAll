{"version":3,"sources":["../src/operations.js"],"names":[],"mappings":"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","file":"operations.js","sourcesContent":["const _ = require('lodash')\r\nconst http = require('http')\r\nconst moredots = require('moredots')\r\n\r\nmodule.exports = function (model, options, excludedMap) {\r\n  const buildQuery = require('./buildQuery')(options)\r\n  const errorHandler = require('./errorHandler')(options)\r\n\r\n  function findById (filteredContext, id) {\r\n    return filteredContext.findOne().and({\r\n      [options.idProperty]: id\r\n    })\r\n  }\r\n\r\n  function isDistinctExcluded (req) {\r\n    return options.filter.isExcluded(req._ermQueryOptions['distinct'], {\r\n      access: req.access,\r\n      excludedMap: excludedMap\r\n    })\r\n  }\r\n\r\n  function getItems (req, res, next) {\r\n    if (isDistinctExcluded(req)) {\r\n      req.erm.result = []\r\n      req.erm.statusCode = 200\r\n      return next()\r\n    }\r\n\r\n    options.contextFilter(model, req, (filteredContext) => {\r\n      let query = buildQuery(filteredContext.find(), req._ermQueryOptions).read(options.readPreference)\r\n\r\n      query.lean(options.lean).exec().then((items) => {\r\n        req.erm.result = items\r\n        req.erm.statusCode = 200\r\n\r\n        if (options.totalCountHeader) {\r\n          query.skip(0).limit(0).count().then((count) => {\r\n            req.erm.totalCount = count\r\n            next()\r\n          }, errorHandler(req, res, next))\r\n        } else {\r\n          next()\r\n        }\r\n      }, errorHandler(req, res, next))\r\n    })\r\n  }\r\n\r\n  function getCount (req, res, next) {\r\n    options.contextFilter(model, req, (filteredContext) => {\r\n      buildQuery(filteredContext.count(), req._ermQueryOptions).exec().then((count) => {\r\n        req.erm.result = { count: count }\r\n        req.erm.statusCode = 200\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    })\r\n  }\r\n\r\n  function getShallow (req, res, next) {\r\n    options.contextFilter(model, req, (filteredContext) => {\r\n      buildQuery(findById(filteredContext, req.params.id), req._ermQueryOptions).lean(options.lean).read(options.readPreference).exec().then((item) => {\r\n        if (!item) {\r\n          return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]))\r\n        }\r\n\r\n        for (let prop in item) {\r\n          item[prop] = typeof item[prop] === 'object' && prop !== '_id' ? true : item[prop]\r\n        }\r\n\r\n        req.erm.result = item\r\n        req.erm.statusCode = 200\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    })\r\n  }\r\n\r\n  function deleteItems (req, res, next) {\r\n    options.contextFilter(model, req, (filteredContext) => {\r\n      buildQuery(filteredContext.find(), req._ermQueryOptions).remove().then(() => {\r\n        req.erm.statusCode = 204\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    })\r\n  }\r\n\r\n  function getItem (req, res, next) {\r\n    if (isDistinctExcluded(req)) {\r\n      req.erm.result = []\r\n      req.erm.statusCode = 200\r\n      return next()\r\n    }\r\n\r\n    options.contextFilter(model, req, (filteredContext) => {\r\n      buildQuery(findById(filteredContext, req.params.id), req._ermQueryOptions).lean(options.lean).read(options.readPreference).exec().then((item) => {\r\n        if (!item) {\r\n          return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]))\r\n        }\r\n\r\n        req.erm.result = item\r\n        req.erm.statusCode = 200\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    })\r\n  }\r\n\r\n  function deleteItem (req, res, next) {\r\n    if (options.findOneAndRemove) {\r\n      options.contextFilter(model, req, (filteredContext) => {\r\n        findById(filteredContext, req.params.id).findOneAndRemove().then((item) => {\r\n          if (!item) {\r\n            return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]))\r\n          }\r\n\r\n          req.erm.statusCode = 204\r\n\r\n          next()\r\n        }, errorHandler(req, res, next))\r\n      })\r\n    } else {\r\n      req.erm.document.remove().then(() => {\r\n        req.erm.statusCode = 204\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    }\r\n  }\r\n\r\n  function createObject (req, res, next) {\r\n    req.body = options.filter.filterObject(req.body || {}, {\r\n      access: req.access,\r\n      populate: req._ermQueryOptions.populate\r\n    })\r\n\r\n    if (model.schema.options._id) {\r\n      delete req.body._id\r\n    }\r\n\r\n    if (model.schema.options.versionKey) {\r\n      delete req.body[model.schema.options.versionKey]\r\n    }\r\n\r\n    model.create(req.body).then((item) => model.populate(item, req._ermQueryOptions.populate || [])).then((item) => {\r\n      req.erm.result = item\r\n      req.erm.statusCode = 201\r\n\r\n      next()\r\n    }, errorHandler(req, res, next))\r\n  }\r\n\r\n  function modifyObject (req, res, next) {\r\n    req.body = options.filter.filterObject(req.body || {}, {\r\n      access: req.access,\r\n      populate: req._ermQueryOptions.populate\r\n    })\r\n\r\n    delete req.body._id\r\n\r\n    if (model.schema.options.versionKey) {\r\n      delete req.body[model.schema.options.versionKey]\r\n    }\r\n\r\n    function depopulate (src) {\r\n      let dst = {}\r\n\r\n      for (let key in src) {\r\n        const path = model.schema.path(key)\r\n\r\n        if (path && path.caster && path.caster.instance === 'ObjectID') {\r\n          if (_.isArray(src[key])) {\r\n            for (let j = 0; j < src[key].length; ++j) {\r\n              if (typeof src[key][j] === 'object') {\r\n                dst[key] = dst[key] || {}\r\n                dst[key][j] = src[key][j]._id\r\n              }\r\n            }\r\n          } else if (_.isPlainObject(src[key])) {\r\n            dst[key] = src[key]._id\r\n          }\r\n        } else if (_.isPlainObject(src[key])) {\r\n          if (path && path.instance === 'ObjectID') {\r\n            dst[key] = src[key]._id\r\n          } else {\r\n            dst[key] = depopulate(src[key])\r\n          }\r\n        }\r\n\r\n        if (_.isUndefined(dst[key])) {\r\n          dst[key] = src[key]\r\n        }\r\n      }\r\n\r\n      return dst\r\n    }\r\n\r\n    const cleanBody = moredots(depopulate(req.body))\r\n\r\n    if (options.findOneAndUpdate) {\r\n      options.contextFilter(model, req, (filteredContext) => {\r\n        findById(filteredContext, req.params.id).findOneAndUpdate({}, {\r\n          $set: cleanBody\r\n        }, {\r\n          new: true,\r\n          runValidators: options.runValidators\r\n        }).exec().then((item) => model.populate(item, req._ermQueryOptions.populate || [])).then((item) => {\r\n          if (!item) {\r\n            return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]))\r\n          }\r\n\r\n          req.erm.result = item\r\n          req.erm.statusCode = 200\r\n\r\n          next()\r\n        }, errorHandler(req, res, next))\r\n      })\r\n    } else {\r\n      for (let key in cleanBody) {\r\n        req.erm.document.set(key, cleanBody[key])\r\n      }\r\n\r\n      req.erm.document.save().then((item) => model.populate(item, req._ermQueryOptions.populate || [])).then((item) => {\r\n        req.erm.result = item\r\n        req.erm.statusCode = 200\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    }\r\n  }\r\n\r\n  return { getItems, getCount, getItem, getShallow, createObject, modifyObject, deleteItems, deleteItem }\r\n}\r\n"]}