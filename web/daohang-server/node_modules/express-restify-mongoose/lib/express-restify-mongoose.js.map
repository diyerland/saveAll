{"version":3,"sources":["../src/express-restify-mongoose.js"],"names":[],"mappings":"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","file":"express-restify-mongoose.js","sourcesContent":["const util = require('util')\r\nconst _ = require('lodash')\r\nconst Filter = require('./resource_filter')\r\nlet customDefaults = null\r\nlet excludedMap = {}\r\n\r\nfunction getDefaults () {\r\n  return _.defaults(customDefaults || {}, {\r\n    prefix: '/api',\r\n    version: '/v1',\r\n    idProperty: '_id',\r\n    findOneAndUpdate: true,\r\n    findOneAndRemove: true,\r\n    lean: true,\r\n    restify: false,\r\n    runValidators: false,\r\n    allowRegex: true,\r\n    private: [],\r\n    protected: []\r\n  })\r\n}\r\n\r\nconst restify = function (app, model, opts = {}) {\r\n  let options = {}\r\n  _.assign(options, getDefaults(), opts)\r\n\r\n  const access = require('./middleware/access')\r\n  const ensureContentType = require('./middleware/ensureContentType')(options)\r\n  const filterAndFindById = require('./middleware/filterAndFindById')(model, options)\r\n  const onError = require('./middleware/onError')\r\n  const outputFn = require('./middleware/outputFn')\r\n  const prepareQuery = require('./middleware/prepareQuery')(options)\r\n  const prepareOutput = require('./middleware/prepareOutput')(options, excludedMap)\r\n\r\n  if (!_.isArray(options.private)) {\r\n    throw new Error('\"options.private\" must be an array of fields')\r\n  }\r\n\r\n  if (!_.isArray(options.protected)) {\r\n    throw new Error('\"options.protected\" must be an array of fields')\r\n  }\r\n\r\n  model.schema.eachPath((name, path) => {\r\n    if (path.options.access) {\r\n      switch (path.options.access.toLowerCase()) {\r\n        case 'private':\r\n          options.private.push(name)\r\n          break\r\n        case 'protected':\r\n          options.protected.push(name)\r\n          break\r\n      }\r\n    }\r\n  })\r\n\r\n  options.filter = new Filter({\r\n    model, excludedMap, filteredKeys: {\r\n      private: options.private,\r\n      protected: options.protected\r\n    }\r\n  })\r\n\r\n  excludedMap[model.modelName] = options.filter.filteredKeys\r\n\r\n  if (!_.isArray(options.preMiddleware)) {\r\n    options.preMiddleware = options.preMiddleware ? [options.preMiddleware] : []\r\n  }\r\n\r\n  if (!_.isArray(options.preCreate)) {\r\n    options.preCreate = options.preCreate ? [options.preCreate] : []\r\n  }\r\n\r\n  if (!_.isArray(options.preRead)) {\r\n    options.preRead = options.preRead ? [options.preRead] : []\r\n  }\r\n\r\n  if (!_.isArray(options.preUpdate)) {\r\n    options.preUpdate = options.preUpdate ? [options.preUpdate] : []\r\n  }\r\n\r\n  if (!_.isArray(options.preDelete)) {\r\n    options.preDelete = options.preDelete ? [options.preDelete] : []\r\n  }\r\n\r\n  if (!options.contextFilter) {\r\n    options.contextFilter = (model, req, done) => done(model)\r\n  }\r\n\r\n  if (!_.isArray(options.postCreate)) {\r\n    options.postCreate = options.postCreate ? [options.postCreate] : []\r\n  }\r\n\r\n  if (!_.isArray(options.postRead)) {\r\n    options.postRead = options.postRead ? [options.postRead] : []\r\n  }\r\n\r\n  if (!_.isArray(options.postUpdate)) {\r\n    options.postUpdate = options.postUpdate ? [options.postUpdate] : []\r\n  }\r\n\r\n  if (!_.isArray(options.postDelete)) {\r\n    options.postDelete = options.postDelete ? [options.postDelete] : []\r\n  }\r\n\r\n  if (!options.onError) {\r\n    options.onError = onError(!options.restify)\r\n  }\r\n\r\n  if (!options.outputFn) {\r\n    options.outputFn = outputFn(!options.restify)\r\n  }\r\n\r\n  options.name = options.name || model.modelName\r\n\r\n  const ops = require('./operations')(model, options, excludedMap)\r\n\r\n  let uri_item = `${options.prefix}${options.version}/${options.name}`\r\n  if (uri_item.indexOf('/:id') === -1) {\r\n    uri_item += '/:id'\r\n  }\r\n\r\n  const uri_items = uri_item.replace('/:id', '')\r\n  const uri_count = uri_items + '/count'\r\n  const uri_shallow = uri_item + '/shallow'\r\n\r\n  if (_.isUndefined(app.delete)) {\r\n    app.delete = app.del\r\n  }\r\n\r\n  app.use((req, res, next) => {\r\n    req.erm = { model }\r\n    next()\r\n  })\r\n\r\n  const accessMiddleware = options.access ? access(options) : []\r\n\r\n  app.get(uri_items, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getItems, prepareOutput)\r\n  app.get(uri_count, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getCount, prepareOutput)\r\n  app.get(uri_item, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getItem, prepareOutput)\r\n  app.get(uri_shallow, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getShallow, prepareOutput)\r\n\r\n  app.post(uri_items, prepareQuery, ensureContentType, options.preMiddleware, options.preCreate, accessMiddleware, ops.createObject, prepareOutput)\r\n  app.post(uri_item, util.deprecate(prepareQuery, 'Warning: in a future major version, the POST method to update resources will be removed. Use PATCH instead.'), ensureContentType, options.preMiddleware, options.findOneAndUpdate ? [] : filterAndFindById, options.preUpdate, accessMiddleware, ops.modifyObject, prepareOutput)\r\n\r\n  app.put(uri_item, util.deprecate(prepareQuery, 'Warning: in a future major version, the PUT method will replace rather than update a resource. Use PATCH instead.'), ensureContentType, options.preMiddleware, options.findOneAndUpdate ? [] : filterAndFindById, options.preUpdate, accessMiddleware, ops.modifyObject, prepareOutput)\r\n  app.patch(uri_item, prepareQuery, ensureContentType, options.preMiddleware, options.findOneAndUpdate ? [] : filterAndFindById, options.preUpdate, accessMiddleware, ops.modifyObject, prepareOutput)\r\n\r\n  app.delete(uri_items, prepareQuery, options.preMiddleware, options.preDelete, ops.deleteItems, prepareOutput)\r\n  app.delete(uri_item, prepareQuery, options.preMiddleware, options.findOneAndRemove ? [] : filterAndFindById, options.preDelete, ops.deleteItem, prepareOutput)\r\n\r\n  return uri_items\r\n}\r\n\r\nmodule.exports = {\r\n  defaults: function (options) {\r\n    customDefaults = options\r\n  },\r\n  serve: restify\r\n}\r\n"]}