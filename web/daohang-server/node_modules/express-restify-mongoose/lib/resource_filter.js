'use strict';

var _ = require('lodash');
var detective = require('mongoose-detective');
var weedout = require('weedout');

/**
 * Represents a filter.
 * @constructor
 * @param {Object} opts - Options
 * @param {Object} opts.model - Mongoose model
 * @param {Object} opts.excludedMap {} - Filtered keys for related models
 * @param {Object} opts.filteredKeys {} - Keys to filter for the current model
 */
function Filter(opts) {
  this.model = opts.model;

  this.filteredKeys = _.isPlainObject(opts.filteredKeys) ? {
    private: opts.filteredKeys.private || [],
    protected: opts.filteredKeys.protected || []
  } : {
    private: [],
    protected: []
  };

  if (this.model && this.model.discriminators && _.isPlainObject(opts.excludedMap)) {
    for (var modelName in this.model.discriminators) {
      if (opts.excludedMap[modelName]) {
        this.filteredKeys.private = this.filteredKeys.private.concat(opts.excludedMap[modelName].private);
        this.filteredKeys.protected = this.filteredKeys.protected.concat(opts.excludedMap[modelName].protected);
      }
    }
  }
}

/**
 * Gets excluded keys for a given model and access.
 * @memberof Filter
 * @param {Object} - Options.
 * @param {String} opts.access {public} - Access level (private, protected or public).
 * @param {Object} opts.excludedMap {} - Filtered keys for related models
 * @param {Object} opts.filteredKeys {} - Keys to filter for the current model
 * @returns {Array} - Keys to filter.
 */
Filter.prototype.getExcluded = function (opts) {
  if (opts.access === 'private') {
    return [];
  }

  var entry = opts.excludedMap && opts.modelName ? opts.excludedMap[opts.modelName] : null;

  if (!entry) {
    entry = _.isPlainObject(opts.filteredKeys) ? {
      private: opts.filteredKeys.private || [],
      protected: opts.filteredKeys.protected || []
    } : {
      private: [],
      protected: []
    };
  }

  return opts.access === 'protected' ? entry.private : entry.private.concat(entry.protected);
};

Filter.prototype.isExcluded = function (field, opts) {
  if (!field) {
    return false;
  }

  opts = _.defaults(opts, {
    access: 'public',
    excludedMap: {},
    filteredKeys: this.filteredKeys,
    modelName: this.model.modelName
  });

  return this.getExcluded(opts).indexOf(field) >= 0;
};

/**
 * Removes excluded keys from a document.
 * @memberof Filter
 * @param {Object} - Source document.
 * @param {Array} - Keys to filter.
 * @returns {Object} - Filtered document.
 */
Filter.prototype.filterItem = function (item, excluded) {
  var _this = this;

  if (_.isArray(item)) {
    return item.map(function (i) {
      return _this.filterItem(i, excluded);
    });
  }

  if (item && excluded) {
    if (_.isFunction(item.toObject)) {
      item = item.toObject();
    }

    for (var i = 0, length = excluded.length; i < length; i++) {
      if (excluded[i].indexOf('.') > 0) {
        weedout(item, excluded[i]);
      } else {
        delete item[excluded[i]];
      }
    }
  }

  return item;
};

/**
 * Removes excluded keys from a document with populated subdocuments.
 * @memberof Filter
 * @param {Object} - Source document.
 * @param {Object} - Keys to filter.
 * @param {Array} opts.populate - Paths to populated subdocuments.
 * @param {String} opts.access - Access level (private, protected or public).
 * @param {Object} opts.excludedMap {} - Filtered keys for related models
 * @returns {Object} - Filtered document.
 */
Filter.prototype.filterPopulatedItem = function (item, opts) {
  var _this2 = this;

  if (_.isArray(item)) {
    return item.map(function (i) {
      return _this2.filterPopulatedItem(i, opts);
    });
  }

  for (var i = 0; i < opts.populate.length; i++) {
    if (!opts.populate[i].path) {
      continue;
    }

    var excluded = this.getExcluded({
      access: opts.access,
      excludedMap: opts.excludedMap,
      modelName: detective(this.model, opts.populate[i].path)
    });

    if (_.has(item, opts.populate[i].path)) {
      this.filterItem(_.get(item, opts.populate[i].path), excluded);
    } else {
      var pathToArray = opts.populate[i].path.split('.').slice(0, -1).join('.');

      if (_.has(item, pathToArray)) {
        var array = _.get(item, pathToArray);
        var pathToObject = opts.populate[i].path.split('.').slice(-1).join('.');

        this.filterItem(_.map(array, pathToObject), excluded);
      }
    }
  }

  return item;
};

/**
 * Removes excluded keys from a document.
 * @memberof Filter
 * @access public
 * @param {Object} - Source document.
 * @param {Object} - Options.
 * @param {String} opts.access {public} - Access level (private, protected or public).
 * @param {Object} opts.excludedMap {} - Filtered keys for related models
 * @param {Array} opts.populate - Paths to populated subdocuments.
 * @returns {Object} - Filtered document.
 */
Filter.prototype.filterObject = function (resource) {
  var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];

  opts = _.defaults(opts, {
    access: 'public',
    excludedMap: {},
    filteredKeys: this.filteredKeys,
    modelName: this.model.modelName
  });

  var filtered = this.filterItem(resource, this.getExcluded(opts));

  if (opts.populate) {
    this.filterPopulatedItem(filtered, opts);
  }

  return filtered;
};

module.exports = Filter;
//# sourceMappingURL=data:application/json;base64,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WEY7O0FBeUJBLFNBQU8sSUFBUCxDQTlCMkQ7Q0FBdEI7Ozs7Ozs7Ozs7Ozs7QUE0Q3ZDLE9BQU8sU0FBUCxDQUFpQixZQUFqQixHQUFnQyxVQUFVLFFBQVYsRUFBK0I7TUFBWCw2REFBTyxrQkFBSTs7QUFDN0QsU0FBTyxFQUFFLFFBQUYsQ0FBVyxJQUFYLEVBQWlCO0FBQ3RCLFlBQVEsUUFBUjtBQUNBLGlCQUFhLEVBQWI7QUFDQSxrQkFBYyxLQUFLLFlBQUw7QUFDZCxlQUFXLEtBQUssS0FBTCxDQUFXLFNBQVg7R0FKTixDQUFQLENBRDZEOztBQVE3RCxNQUFJLFdBQVcsS0FBSyxVQUFMLENBQWdCLFFBQWhCLEVBQTBCLEtBQUssV0FBTCxDQUFpQixJQUFqQixDQUExQixDQUFYLENBUnlEOztBQVU3RCxNQUFJLEtBQUssUUFBTCxFQUFlO0FBQ2pCLFNBQUssbUJBQUwsQ0FBeUIsUUFBekIsRUFBbUMsSUFBbkMsRUFEaUI7R0FBbkI7O0FBSUEsU0FBTyxRQUFQLENBZDZEO0NBQS9COztBQWlCaEMsT0FBTyxPQUFQLEdBQWlCLE1BQWpCIiwiZmlsZSI6InJlc291cmNlX2ZpbHRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKVxyXG5jb25zdCBkZXRlY3RpdmUgPSByZXF1aXJlKCdtb25nb29zZS1kZXRlY3RpdmUnKVxyXG5jb25zdCB3ZWVkb3V0ID0gcmVxdWlyZSgnd2VlZG91dCcpXHJcblxyXG4vKipcclxuICogUmVwcmVzZW50cyBhIGZpbHRlci5cclxuICogQGNvbnN0cnVjdG9yXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzIC0gT3B0aW9uc1xyXG4gKiBAcGFyYW0ge09iamVjdH0gb3B0cy5tb2RlbCAtIE1vbmdvb3NlIG1vZGVsXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzLmV4Y2x1ZGVkTWFwIHt9IC0gRmlsdGVyZWQga2V5cyBmb3IgcmVsYXRlZCBtb2RlbHNcclxuICogQHBhcmFtIHtPYmplY3R9IG9wdHMuZmlsdGVyZWRLZXlzIHt9IC0gS2V5cyB0byBmaWx0ZXIgZm9yIHRoZSBjdXJyZW50IG1vZGVsXHJcbiAqL1xyXG5mdW5jdGlvbiBGaWx0ZXIgKG9wdHMpIHtcclxuICB0aGlzLm1vZGVsID0gb3B0cy5tb2RlbFxyXG5cclxuICB0aGlzLmZpbHRlcmVkS2V5cyA9IF8uaXNQbGFpbk9iamVjdChvcHRzLmZpbHRlcmVkS2V5cykgPyB7XHJcbiAgICBwcml2YXRlOiBvcHRzLmZpbHRlcmVkS2V5cy5wcml2YXRlIHx8IFtdLFxyXG4gICAgcHJvdGVjdGVkOiBvcHRzLmZpbHRlcmVkS2V5cy5wcm90ZWN0ZWQgfHwgW11cclxuICB9IDoge1xyXG4gICAgcHJpdmF0ZTogW10sXHJcbiAgICBwcm90ZWN0ZWQ6IFtdXHJcbiAgfVxyXG5cclxuICBpZiAodGhpcy5tb2RlbCAmJiB0aGlzLm1vZGVsLmRpc2NyaW1pbmF0b3JzICYmIF8uaXNQbGFpbk9iamVjdChvcHRzLmV4Y2x1ZGVkTWFwKSkge1xyXG4gICAgZm9yIChsZXQgbW9kZWxOYW1lIGluIHRoaXMubW9kZWwuZGlzY3JpbWluYXRvcnMpIHtcclxuICAgICAgaWYgKG9wdHMuZXhjbHVkZWRNYXBbbW9kZWxOYW1lXSkge1xyXG4gICAgICAgIHRoaXMuZmlsdGVyZWRLZXlzLnByaXZhdGUgPSB0aGlzLmZpbHRlcmVkS2V5cy5wcml2YXRlLmNvbmNhdChvcHRzLmV4Y2x1ZGVkTWFwW21vZGVsTmFtZV0ucHJpdmF0ZSlcclxuICAgICAgICB0aGlzLmZpbHRlcmVkS2V5cy5wcm90ZWN0ZWQgPSB0aGlzLmZpbHRlcmVkS2V5cy5wcm90ZWN0ZWQuY29uY2F0KG9wdHMuZXhjbHVkZWRNYXBbbW9kZWxOYW1lXS5wcm90ZWN0ZWQpXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBHZXRzIGV4Y2x1ZGVkIGtleXMgZm9yIGEgZ2l2ZW4gbW9kZWwgYW5kIGFjY2Vzcy5cclxuICogQG1lbWJlcm9mIEZpbHRlclxyXG4gKiBAcGFyYW0ge09iamVjdH0gLSBPcHRpb25zLlxyXG4gKiBAcGFyYW0ge1N0cmluZ30gb3B0cy5hY2Nlc3Mge3B1YmxpY30gLSBBY2Nlc3MgbGV2ZWwgKHByaXZhdGUsIHByb3RlY3RlZCBvciBwdWJsaWMpLlxyXG4gKiBAcGFyYW0ge09iamVjdH0gb3B0cy5leGNsdWRlZE1hcCB7fSAtIEZpbHRlcmVkIGtleXMgZm9yIHJlbGF0ZWQgbW9kZWxzXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzLmZpbHRlcmVkS2V5cyB7fSAtIEtleXMgdG8gZmlsdGVyIGZvciB0aGUgY3VycmVudCBtb2RlbFxyXG4gKiBAcmV0dXJucyB7QXJyYXl9IC0gS2V5cyB0byBmaWx0ZXIuXHJcbiAqL1xyXG5GaWx0ZXIucHJvdG90eXBlLmdldEV4Y2x1ZGVkID0gZnVuY3Rpb24gKG9wdHMpIHtcclxuICBpZiAob3B0cy5hY2Nlc3MgPT09ICdwcml2YXRlJykge1xyXG4gICAgcmV0dXJuIFtdXHJcbiAgfVxyXG5cclxuICBsZXQgZW50cnkgPSBvcHRzLmV4Y2x1ZGVkTWFwICYmIG9wdHMubW9kZWxOYW1lID8gb3B0cy5leGNsdWRlZE1hcFtvcHRzLm1vZGVsTmFtZV0gOiBudWxsXHJcblxyXG4gIGlmICghZW50cnkpIHtcclxuICAgIGVudHJ5ID0gXy5pc1BsYWluT2JqZWN0KG9wdHMuZmlsdGVyZWRLZXlzKSA/IHtcclxuICAgICAgcHJpdmF0ZTogb3B0cy5maWx0ZXJlZEtleXMucHJpdmF0ZSB8fCBbXSxcclxuICAgICAgcHJvdGVjdGVkOiBvcHRzLmZpbHRlcmVkS2V5cy5wcm90ZWN0ZWQgfHwgW11cclxuICAgIH0gOiB7XHJcbiAgICAgIHByaXZhdGU6IFtdLFxyXG4gICAgICBwcm90ZWN0ZWQ6IFtdXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4gb3B0cy5hY2Nlc3MgPT09ICdwcm90ZWN0ZWQnID8gZW50cnkucHJpdmF0ZSA6IGVudHJ5LnByaXZhdGUuY29uY2F0KGVudHJ5LnByb3RlY3RlZClcclxufVxyXG5cclxuRmlsdGVyLnByb3RvdHlwZS5pc0V4Y2x1ZGVkID0gZnVuY3Rpb24gKGZpZWxkLCBvcHRzKSB7XHJcbiAgaWYgKCFmaWVsZCkge1xyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG5cclxuICBvcHRzID0gXy5kZWZhdWx0cyhvcHRzLCB7XHJcbiAgICBhY2Nlc3M6ICdwdWJsaWMnLFxyXG4gICAgZXhjbHVkZWRNYXA6IHt9LFxyXG4gICAgZmlsdGVyZWRLZXlzOiB0aGlzLmZpbHRlcmVkS2V5cyxcclxuICAgIG1vZGVsTmFtZTogdGhpcy5tb2RlbC5tb2RlbE5hbWVcclxuICB9KVxyXG5cclxuICByZXR1cm4gdGhpcy5nZXRFeGNsdWRlZChvcHRzKS5pbmRleE9mKGZpZWxkKSA+PSAwXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBSZW1vdmVzIGV4Y2x1ZGVkIGtleXMgZnJvbSBhIGRvY3VtZW50LlxyXG4gKiBAbWVtYmVyb2YgRmlsdGVyXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSAtIFNvdXJjZSBkb2N1bWVudC5cclxuICogQHBhcmFtIHtBcnJheX0gLSBLZXlzIHRvIGZpbHRlci5cclxuICogQHJldHVybnMge09iamVjdH0gLSBGaWx0ZXJlZCBkb2N1bWVudC5cclxuICovXHJcbkZpbHRlci5wcm90b3R5cGUuZmlsdGVySXRlbSA9IGZ1bmN0aW9uIChpdGVtLCBleGNsdWRlZCkge1xyXG4gIGlmIChfLmlzQXJyYXkoaXRlbSkpIHtcclxuICAgIHJldHVybiBpdGVtLm1hcCgoaSkgPT4gdGhpcy5maWx0ZXJJdGVtKGksIGV4Y2x1ZGVkKSlcclxuICB9XHJcblxyXG4gIGlmIChpdGVtICYmIGV4Y2x1ZGVkKSB7XHJcbiAgICBpZiAoXy5pc0Z1bmN0aW9uKGl0ZW0udG9PYmplY3QpKSB7XHJcbiAgICAgIGl0ZW0gPSBpdGVtLnRvT2JqZWN0KClcclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGxldCBpID0gMCwgbGVuZ3RoID0gZXhjbHVkZWQubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHtcclxuICAgICAgaWYgKGV4Y2x1ZGVkW2ldLmluZGV4T2YoJy4nKSA+IDApIHtcclxuICAgICAgICB3ZWVkb3V0KGl0ZW0sIGV4Y2x1ZGVkW2ldKVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRlbGV0ZSBpdGVtW2V4Y2x1ZGVkW2ldXVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4gaXRlbVxyXG59XHJcblxyXG4vKipcclxuICogUmVtb3ZlcyBleGNsdWRlZCBrZXlzIGZyb20gYSBkb2N1bWVudCB3aXRoIHBvcHVsYXRlZCBzdWJkb2N1bWVudHMuXHJcbiAqIEBtZW1iZXJvZiBGaWx0ZXJcclxuICogQHBhcmFtIHtPYmplY3R9IC0gU291cmNlIGRvY3VtZW50LlxyXG4gKiBAcGFyYW0ge09iamVjdH0gLSBLZXlzIHRvIGZpbHRlci5cclxuICogQHBhcmFtIHtBcnJheX0gb3B0cy5wb3B1bGF0ZSAtIFBhdGhzIHRvIHBvcHVsYXRlZCBzdWJkb2N1bWVudHMuXHJcbiAqIEBwYXJhbSB7U3RyaW5nfSBvcHRzLmFjY2VzcyAtIEFjY2VzcyBsZXZlbCAocHJpdmF0ZSwgcHJvdGVjdGVkIG9yIHB1YmxpYykuXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzLmV4Y2x1ZGVkTWFwIHt9IC0gRmlsdGVyZWQga2V5cyBmb3IgcmVsYXRlZCBtb2RlbHNcclxuICogQHJldHVybnMge09iamVjdH0gLSBGaWx0ZXJlZCBkb2N1bWVudC5cclxuICovXHJcbkZpbHRlci5wcm90b3R5cGUuZmlsdGVyUG9wdWxhdGVkSXRlbSA9IGZ1bmN0aW9uIChpdGVtLCBvcHRzKSB7XHJcbiAgaWYgKF8uaXNBcnJheShpdGVtKSkge1xyXG4gICAgcmV0dXJuIGl0ZW0ubWFwKChpKSA9PiB0aGlzLmZpbHRlclBvcHVsYXRlZEl0ZW0oaSwgb3B0cykpXHJcbiAgfVxyXG5cclxuICBmb3IgKGxldCBpID0gMDsgaSA8IG9wdHMucG9wdWxhdGUubGVuZ3RoOyBpKyspIHtcclxuICAgIGlmICghb3B0cy5wb3B1bGF0ZVtpXS5wYXRoKSB7XHJcbiAgICAgIGNvbnRpbnVlXHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZXhjbHVkZWQgPSB0aGlzLmdldEV4Y2x1ZGVkKHtcclxuICAgICAgYWNjZXNzOiBvcHRzLmFjY2VzcyxcclxuICAgICAgZXhjbHVkZWRNYXA6IG9wdHMuZXhjbHVkZWRNYXAsXHJcbiAgICAgIG1vZGVsTmFtZTogZGV0ZWN0aXZlKHRoaXMubW9kZWwsIG9wdHMucG9wdWxhdGVbaV0ucGF0aClcclxuICAgIH0pXHJcblxyXG4gICAgaWYgKF8uaGFzKGl0ZW0sIG9wdHMucG9wdWxhdGVbaV0ucGF0aCkpIHtcclxuICAgICAgdGhpcy5maWx0ZXJJdGVtKF8uZ2V0KGl0ZW0sIG9wdHMucG9wdWxhdGVbaV0ucGF0aCksIGV4Y2x1ZGVkKVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc3QgcGF0aFRvQXJyYXkgPSBvcHRzLnBvcHVsYXRlW2ldLnBhdGguc3BsaXQoJy4nKS5zbGljZSgwLCAtMSkuam9pbignLicpXHJcblxyXG4gICAgICBpZiAoXy5oYXMoaXRlbSwgcGF0aFRvQXJyYXkpKSB7XHJcbiAgICAgICAgY29uc3QgYXJyYXkgPSBfLmdldChpdGVtLCBwYXRoVG9BcnJheSlcclxuICAgICAgICBjb25zdCBwYXRoVG9PYmplY3QgPSBvcHRzLnBvcHVsYXRlW2ldLnBhdGguc3BsaXQoJy4nKS5zbGljZSgtMSkuam9pbignLicpXHJcblxyXG4gICAgICAgIHRoaXMuZmlsdGVySXRlbShfLm1hcChhcnJheSwgcGF0aFRvT2JqZWN0KSwgZXhjbHVkZWQpXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJldHVybiBpdGVtXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBSZW1vdmVzIGV4Y2x1ZGVkIGtleXMgZnJvbSBhIGRvY3VtZW50LlxyXG4gKiBAbWVtYmVyb2YgRmlsdGVyXHJcbiAqIEBhY2Nlc3MgcHVibGljXHJcbiAqIEBwYXJhbSB7T2JqZWN0fSAtIFNvdXJjZSBkb2N1bWVudC5cclxuICogQHBhcmFtIHtPYmplY3R9IC0gT3B0aW9ucy5cclxuICogQHBhcmFtIHtTdHJpbmd9IG9wdHMuYWNjZXNzIHtwdWJsaWN9IC0gQWNjZXNzIGxldmVsIChwcml2YXRlLCBwcm90ZWN0ZWQgb3IgcHVibGljKS5cclxuICogQHBhcmFtIHtPYmplY3R9IG9wdHMuZXhjbHVkZWRNYXAge30gLSBGaWx0ZXJlZCBrZXlzIGZvciByZWxhdGVkIG1vZGVsc1xyXG4gKiBAcGFyYW0ge0FycmF5fSBvcHRzLnBvcHVsYXRlIC0gUGF0aHMgdG8gcG9wdWxhdGVkIHN1YmRvY3VtZW50cy5cclxuICogQHJldHVybnMge09iamVjdH0gLSBGaWx0ZXJlZCBkb2N1bWVudC5cclxuICovXHJcbkZpbHRlci5wcm90b3R5cGUuZmlsdGVyT2JqZWN0ID0gZnVuY3Rpb24gKHJlc291cmNlLCBvcHRzID0ge30pIHtcclxuICBvcHRzID0gXy5kZWZhdWx0cyhvcHRzLCB7XHJcbiAgICBhY2Nlc3M6ICdwdWJsaWMnLFxyXG4gICAgZXhjbHVkZWRNYXA6IHt9LFxyXG4gICAgZmlsdGVyZWRLZXlzOiB0aGlzLmZpbHRlcmVkS2V5cyxcclxuICAgIG1vZGVsTmFtZTogdGhpcy5tb2RlbC5tb2RlbE5hbWVcclxuICB9KVxyXG5cclxuICBsZXQgZmlsdGVyZWQgPSB0aGlzLmZpbHRlckl0ZW0ocmVzb3VyY2UsIHRoaXMuZ2V0RXhjbHVkZWQob3B0cykpXHJcblxyXG4gIGlmIChvcHRzLnBvcHVsYXRlKSB7XHJcbiAgICB0aGlzLmZpbHRlclBvcHVsYXRlZEl0ZW0oZmlsdGVyZWQsIG9wdHMpXHJcbiAgfVxyXG5cclxuICByZXR1cm4gZmlsdGVyZWRcclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBGaWx0ZXJcclxuIl19
//# sourceMappingURL=resource_filter.js.map