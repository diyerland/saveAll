{"version":3,"sources":["../src/resource_filter.js"],"names":[],"mappings":"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","file":"resource_filter.js","sourcesContent":["const _ = require('lodash')\r\nconst detective = require('mongoose-detective')\r\nconst weedout = require('weedout')\r\n\r\n/**\r\n * Represents a filter.\r\n * @constructor\r\n * @param {Object} opts - Options\r\n * @param {Object} opts.model - Mongoose model\r\n * @param {Object} opts.excludedMap {} - Filtered keys for related models\r\n * @param {Object} opts.filteredKeys {} - Keys to filter for the current model\r\n */\r\nfunction Filter (opts) {\r\n  this.model = opts.model\r\n\r\n  this.filteredKeys = _.isPlainObject(opts.filteredKeys) ? {\r\n    private: opts.filteredKeys.private || [],\r\n    protected: opts.filteredKeys.protected || []\r\n  } : {\r\n    private: [],\r\n    protected: []\r\n  }\r\n\r\n  if (this.model && this.model.discriminators && _.isPlainObject(opts.excludedMap)) {\r\n    for (let modelName in this.model.discriminators) {\r\n      if (opts.excludedMap[modelName]) {\r\n        this.filteredKeys.private = this.filteredKeys.private.concat(opts.excludedMap[modelName].private)\r\n        this.filteredKeys.protected = this.filteredKeys.protected.concat(opts.excludedMap[modelName].protected)\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Gets excluded keys for a given model and access.\r\n * @memberof Filter\r\n * @param {Object} - Options.\r\n * @param {String} opts.access {public} - Access level (private, protected or public).\r\n * @param {Object} opts.excludedMap {} - Filtered keys for related models\r\n * @param {Object} opts.filteredKeys {} - Keys to filter for the current model\r\n * @returns {Array} - Keys to filter.\r\n */\r\nFilter.prototype.getExcluded = function (opts) {\r\n  if (opts.access === 'private') {\r\n    return []\r\n  }\r\n\r\n  let entry = opts.excludedMap && opts.modelName ? opts.excludedMap[opts.modelName] : null\r\n\r\n  if (!entry) {\r\n    entry = _.isPlainObject(opts.filteredKeys) ? {\r\n      private: opts.filteredKeys.private || [],\r\n      protected: opts.filteredKeys.protected || []\r\n    } : {\r\n      private: [],\r\n      protected: []\r\n    }\r\n  }\r\n\r\n  return opts.access === 'protected' ? entry.private : entry.private.concat(entry.protected)\r\n}\r\n\r\nFilter.prototype.isExcluded = function (field, opts) {\r\n  if (!field) {\r\n    return false\r\n  }\r\n\r\n  opts = _.defaults(opts, {\r\n    access: 'public',\r\n    excludedMap: {},\r\n    filteredKeys: this.filteredKeys,\r\n    modelName: this.model.modelName\r\n  })\r\n\r\n  return this.getExcluded(opts).indexOf(field) >= 0\r\n}\r\n\r\n/**\r\n * Removes excluded keys from a document.\r\n * @memberof Filter\r\n * @param {Object} - Source document.\r\n * @param {Array} - Keys to filter.\r\n * @returns {Object} - Filtered document.\r\n */\r\nFilter.prototype.filterItem = function (item, excluded) {\r\n  if (_.isArray(item)) {\r\n    return item.map((i) => this.filterItem(i, excluded))\r\n  }\r\n\r\n  if (item && excluded) {\r\n    if (_.isFunction(item.toObject)) {\r\n      item = item.toObject()\r\n    }\r\n\r\n    for (let i = 0, length = excluded.length; i < length; i++) {\r\n      if (excluded[i].indexOf('.') > 0) {\r\n        weedout(item, excluded[i])\r\n      } else {\r\n        delete item[excluded[i]]\r\n      }\r\n    }\r\n  }\r\n\r\n  return item\r\n}\r\n\r\n/**\r\n * Removes excluded keys from a document with populated subdocuments.\r\n * @memberof Filter\r\n * @param {Object} - Source document.\r\n * @param {Object} - Keys to filter.\r\n * @param {Array} opts.populate - Paths to populated subdocuments.\r\n * @param {String} opts.access - Access level (private, protected or public).\r\n * @param {Object} opts.excludedMap {} - Filtered keys for related models\r\n * @returns {Object} - Filtered document.\r\n */\r\nFilter.prototype.filterPopulatedItem = function (item, opts) {\r\n  if (_.isArray(item)) {\r\n    return item.map((i) => this.filterPopulatedItem(i, opts))\r\n  }\r\n\r\n  for (let i = 0; i < opts.populate.length; i++) {\r\n    if (!opts.populate[i].path) {\r\n      continue\r\n    }\r\n\r\n    const excluded = this.getExcluded({\r\n      access: opts.access,\r\n      excludedMap: opts.excludedMap,\r\n      modelName: detective(this.model, opts.populate[i].path)\r\n    })\r\n\r\n    if (_.has(item, opts.populate[i].path)) {\r\n      this.filterItem(_.get(item, opts.populate[i].path), excluded)\r\n    } else {\r\n      const pathToArray = opts.populate[i].path.split('.').slice(0, -1).join('.')\r\n\r\n      if (_.has(item, pathToArray)) {\r\n        const array = _.get(item, pathToArray)\r\n        const pathToObject = opts.populate[i].path.split('.').slice(-1).join('.')\r\n\r\n        this.filterItem(_.map(array, pathToObject), excluded)\r\n      }\r\n    }\r\n  }\r\n\r\n  return item\r\n}\r\n\r\n/**\r\n * Removes excluded keys from a document.\r\n * @memberof Filter\r\n * @access public\r\n * @param {Object} - Source document.\r\n * @param {Object} - Options.\r\n * @param {String} opts.access {public} - Access level (private, protected or public).\r\n * @param {Object} opts.excludedMap {} - Filtered keys for related models\r\n * @param {Array} opts.populate - Paths to populated subdocuments.\r\n * @returns {Object} - Filtered document.\r\n */\r\nFilter.prototype.filterObject = function (resource, opts = {}) {\r\n  opts = _.defaults(opts, {\r\n    access: 'public',\r\n    excludedMap: {},\r\n    filteredKeys: this.filteredKeys,\r\n    modelName: this.model.modelName\r\n  })\r\n\r\n  let filtered = this.filterItem(resource, this.getExcluded(opts))\r\n\r\n  if (opts.populate) {\r\n    this.filterPopulatedItem(filtered, opts)\r\n  }\r\n\r\n  return filtered\r\n}\r\n\r\nmodule.exports = Filter\r\n"]}